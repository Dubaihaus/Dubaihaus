generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- USERS ---
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      Role     @default(ADMIN)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Role {
  ADMIN
  EDITOR
}

// --- PROPERTIES ---
model Property {
  id          String            @id @default(cuid())
  title       String
  description String
  location    String
  price       Float
  area        Float
  bedrooms    Int
  bathrooms   Int
  status      PropertyStatus
  featured    Boolean           @default(false)
  images      PropertyImage[]
  amenities   PropertyAmenity[]
  media       Media[]
  seo         SEO?              @relation(fields: [seoId], references: [id])
  seoId       String?           @unique
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // NEW:
  blogHighlights BlogPostProperty[]

  // NEW: Detail extensions
  details       PropertyDetails?
  gallery       PropertyGalleryImage[]
  paymentPlans  PropertyPaymentPlan[]
  types         PropertyType[]
  features      PropertyFeature[]
}

model BlogPostProperty {
  id          String   @id @default(cuid())

  blog        BlogPost @relation(fields: [blogId], references: [id])
  blogId      String

  property    Property @relation(fields: [propertyId], references: [id])
  propertyId  String

  position    Int      @default(0) // ordering inside the article

  @@unique([blogId, propertyId])
}

// --- PROPERTY DETAILS EXTENSIONS ---

model PropertyDetails {
  id                String    @id @default(cuid())
  property          Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId        String    @unique

  developerName     String?
  constructionStatus String?
  saleStatus        String?
  furnishing        String?
  
  completionDate    DateTime?
  handoverDate      DateTime?

  overviewTitle     String?
  overviewText      String?   @db.Text
  
  locationDescription String? @db.Text
  // We can store bullet points or JSON for benefits
  locationBenefits    Json?   

  signatureTitle    String?
  signatureSubtitle String?
  
  featuredPaymentPlanTitle String?

  updatedAt         DateTime @updatedAt
}

model PropertyGalleryImage {
  id         String   @id @default(cuid())
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId String

  url        String
  category   String   @default("EXTERIOR") // EXTERIOR, INTERIOR, FEATURE
  position   Int      @default(0)

  updatedAt  DateTime @updatedAt
}

model PropertyPaymentPlan {
  id         String   @id @default(cuid())
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId String

  title      String
  subtitle   String?
  
  steps      PropertyPaymentPlanStep[]

  updatedAt  DateTime @updatedAt
}

model PropertyPaymentPlanStep {
  id            String              @id @default(cuid())
  plan          PropertyPaymentPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  planId        String

  percent       String
  label         String
  note          String?
  position      Int                 @default(0)
}

model PropertyType {
  id         String   @id @default(cuid())
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId String

  name       String   // Studio, 1BR, etc
  sizeFrom   String?
  sizeTo     String?
  priceFrom  String?
  
  position   Int      @default(0)
}

model PropertyFeature {
  id         String   @id @default(cuid())
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  propertyId String

  text       String
  position   Int      @default(0)
}

enum PropertyStatus {
  FOR_SALE
  FOR_RENT
  SOLD
}

model PropertyImage {
  id         String   @id @default(cuid())
  url        String
  property   Property @relation(fields: [propertyId], references: [id])
  propertyId String
}

model PropertyAmenity {
  id         String   @id @default(cuid())
  name       String
  property   Property @relation(fields: [propertyId], references: [id])
  propertyId String
}

// --- BLOG POSTS ---
model BlogPost {
  id          String              @id @default(cuid())
  title       String
  excerpt     String?             @db.Text   // short summary for list / meta
  content     String              @db.Text   // full article, markdown or text
  featuredImg String?
  readMinutes Int?                // e.g. 5 (min)
  status      BlogStatus          @default(DRAFT)
  publishedAt DateTime?           // null = draft

  // NEW: Many-to-many relations via join tables
  categoryLinks BlogPostCategory[]
  tagLinks      BlogPostTag[]
  media         Media[]

  seo         SEO?                @relation(fields: [seoId], references: [id])
  seoId       String?             @unique

  // Properties mentioned in this blog (many-to-many via join table)
  featuredProperties BlogPostProperty[]

  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
}

// Global category model (reusable across posts)
model BlogCategory {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?  @db.Text
  isFeatured  Boolean  @default(false)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Reverse relation to join table
  posts       BlogPostCategory[]
}

// Join table for BlogPost <-> BlogCategory
model BlogPostCategory {
  id         String       @id @default(cuid())
  blog       BlogPost     @relation(fields: [blogId], references: [id], onDelete: Cascade)
  blogId     String
  category   BlogCategory @relation(fields: [categoryId], references: [id])
  categoryId String
  position   Int          @default(0)
  
  @@unique([blogId, categoryId])
  @@index([blogId])
  @@index([categoryId])
}

// Global tag model (reusable across posts)
model BlogTag {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Reverse relation to join table
  posts     BlogPostTag[]
}

// Join table for BlogPost <-> BlogTag
model BlogPostTag {
  id     String   @id @default(cuid())
  blog   BlogPost @relation(fields: [blogId], references: [id], onDelete: Cascade)
  blogId String
  tag    BlogTag  @relation(fields: [tagId], references: [id])
  tagId  String
  
  @@unique([blogId, tagId])
  @@index([blogId])
  @@index([tagId])
}

// --- SEO META ---
model SEO {
  id        String  @id @default(cuid())
  metaTitle String?
  metaDesc  String?
  slug      String  @unique

  property Property?
  blog     BlogPost?
}
enum BlogStatus {
  DRAFT
  PUBLISHED
}


enum MediaType {
  IMAGE
  VIDEO
  FLOORPLAN
  FILE
}

enum MediaRole {
  HERO
  INLINE
  GALLERY
}

// --- MEDIA ---
model Media {
  id         String    @id @default(cuid())
  url        String
  type       MediaType
  
  // New fields for blog media richness
  role       MediaRole? @default(INLINE) 
  alt        String?
  caption    String?
  position   Int        @default(0)

  property   Property? @relation(fields: [propertyId], references: [id])
  propertyId String?
  blog       BlogPost? @relation(fields: [blogId], references: [id])
  blogId     String?
  createdAt  DateTime  @default(now())
  
  // Cloudinary Public ID for cleanup
  publicId   String?
}

model Translation {
  id             Int      @id @default(autoincrement())
  key            String   @unique // hash key
  sourceText     String
  sourceLang     String   @default("en")
  targetLang     String
  translatedText String
  provider       String   @default("deepl")
  usageCount     Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model CurrencyRate {
  id        Int      @id @default(autoincrement())
  base      String // e.g. "AED"
  target    String // e.g. "USD"
  rate      Float // e.g. 0.27 (1 AED = 0.27 USD)
  provider  String   @default("exchangerateapi")
  fetchedAt DateTime @default(now())

  @@unique([base, target])
}

// --- REELLY CACHE ---
model ReellyProject {
  id          Int     @id // matches Reelly ID
  slug        String? @unique
  title       String
  description String? @db.Text

  // Location
  locationString String?
  city           String?
  area           String?
  region         String?
  district       String?

  latitude  Float?
  longitude Float?

  // Developer
  developerName String?

  // Status
  status             String?
  saleStatus         String?
  constructionStatus String?

  // Prices & Specs
  priceFrom Decimal?
  priceTo   Decimal?
  currency  String?  @default("AED")

  bedroomsMin Int?
  bedroomsMax Int?

  areaFrom Decimal?
  areaTo   Decimal?
  areaUnit String?

  // Dates
  completionDate DateTime?
  handoverDate   DateTime?

  // Media
  mainImageUrl String?

  // Flags
  isFeatured Boolean @default(false)
  isComingSoon Boolean @default(false)

  // Sync Meta
  lastSyncedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  paymentPlans  ReellyProjectPaymentPlan[]
  propertyTypes ReellyProjectPropertyType[]
}

model ReellyProjectPaymentPlan {
  id        Int           @id @default(autoincrement())
  projectId Int
  project   ReellyProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  name    String?
  rawData Json?
}

model ReellyProjectPropertyType {
  id        Int           @id @default(autoincrement())
  projectId Int
  project   ReellyProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  type      String
  priceFrom Decimal?
  sizeFrom  Decimal?
  rawData   Json?
}
